{
    "AWSTemplateFormatVersion" : "2010-09-09",
  
    "Description" : "Creates ECS infra for ghost app.",

    "Parameters" : {
        "SourceAccessCIDR" : {
            "Type" : "String",
            "Description" : "Allowed source IPs x.x.x.x/x",
            "Default" : "0.0.0.0/0"
        },
        
        "DBPassword" : {
            "Type" : "String",
            "Description" : "Database password",
            "Default" : "MyDBPassword123"
        },

        "ClassicStack" : {
            "Type" : "String",
            "Description" : "Name of ec2 stack",
            "Default" : "Lab4"
        },
        "AccountID" : {
            "Type" : "String",
            "Description" : "Account ID",
            "Default" : "481787744868"
        }
    },

    "Resources" : {
        "GhostCluster" :{
            "Type" : "AWS::ECS::Cluster",
            "Properties" : {
                "CapacityProviders" : [ "FARGATE" ],
                "ClusterName" : "ghost",
                "ClusterSettings" :  [{
                    "Name" : "containerInsights",
                    "Value" : "enabled"               
                }],
                "Tags" : [
                    {"Key" : "Project", "Value" : "ghost" },
                    {"Key" : "Name", "Value" : "Ghost ECS" }]
              }
        },
        "GhostTaskDef" : {
            "Type" : "AWS::ECS::TaskDefinition",
            "Properties" : {
                "ContainerDefinitions" : [ {
                    "Name": "task_def_ghost",
                    "Image": {"Fn::Join": ["", [{"Ref" : "AccountID"}, ".dkr.ecr.us-east-1.amazonaws.com/ghost:5.33"]]},
                    "Cpu": 0,
                    "PortMappings": [
                        {
                            "Name": "ghost_container-2368-tcp",
                            "ContainerPort": 2368,
                            "HostPort": 2368,
                            "Protocol": "tcp"
                        }
                    ],
                    "Essential": true,
                    "Environment": [
                        {
                            "Name": "database__connection__database",
                            "Value": "ghost"
                        },
                        {
                            "Name": "database__connection__host",
                            "Value": {"Fn::ImportValue" : {"Fn::Sub" : "${ClassicStack}-DBDNS"}}
                        },
                        {
                            "Name": "database__connection__password",
                            "Value": {"Ref" : "DBPassword"}
                        },
                        {
                            "Name": "database__client",
                            "Value": "mysql"
                        },
                        {
                            "Name": "database__connection__user",
                            "Value": "ghost"
                        }
                    ],
                    "MountPoints": [
                        {
                            "SourceVolume": "ghost_volume",
                            "ContainerPath": "/var/lib/ghost/content"
                        }
                    ],
                    "LogConfiguration": {
                        "LogDriver": "awslogs",
                        "Options": {
                            "awslogs-create-group": "true",
                            "awslogs-group": "ghost-container",
                            "awslogs-region": "us-east-1",
                            "awslogs-stream-prefix": "ghost"
                        }
                    }
                } ],
                "Cpu" : "256",
                "ExecutionRoleArn" : {"Fn::ImportValue" : {"Fn::Sub" : "${ClassicStack}-ECSIAMarn"}},
                "Family" : "task_def_ghost",
                "Memory" : "1024",
                "NetworkMode" : "awsvpc",
                "RequiresCompatibilities" : [ "FARGATE" ],
                "TaskRoleArn" : {"Fn::ImportValue" : {"Fn::Sub" : "${ClassicStack}-ECSIAMarn"}},
                "Volumes" : [{
                    "EFSVolumeConfiguration" : {
                        "FilesystemId" : {"Fn::ImportValue" : {"Fn::Sub" : "${ClassicStack}-EFSID"}}
                    },
                    "Name" : "ghost_volume"
                  }]
                  
              }
        },
        "GhostService" : {
            "Type" : "AWS::ECS::Service",
            "Properties" : {
                "Cluster" : {"Ref" : "GhostCluster"},
                "DesiredCount" : 1,
                "HealthCheckGracePeriodSeconds" : 30,
                "LaunchType" : "FARGATE",
                "LoadBalancers" : [ {
                    "ContainerName" : "task_def_ghost",
                    "ContainerPort" : 2368,
                    "TargetGroupArn" : "arn:aws:elasticloadbalancing:us-east-1:481787744868:targetgroup/ghost-fargate/87fb13236a3699f0"
                  } ],
                "NetworkConfiguration" : {
                    "AwsvpcConfiguration" : {
                        "AssignPublicIp" : "DISABLED",
                        "SecurityGroups" : [ "sg-0c3e85ad55c29bb57" ],
                        "Subnets" : [ "subnet-00fe6bbb797e6417c", "subnet-0e4385423a59443fd", "subnet-0c1c4dfe7d8bde18a" ]
                      }                      
                  },
                "ServiceName" : "ghost",
                "TaskDefinition" : {"Ref": "GhostTaskDef"}
              }
          }
          
           
    },


    "Outputs" : {

        }
    
}
  